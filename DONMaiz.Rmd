---
title: "DONMaiz"
author: Dosis Optima de N en Maiz
output: 
  flexdashboard::flex_dashboard:
        orientation: columns
        navbar:
           - { icon: "fa-github", href: "https://github.com/adriancorrendo/", align: right }
           - { icon: "fa-twitter", href: "https://twitter.com/aacorrendo/", align: right}
           - { icon: "fa-linkedin", href: "https://www.linkedin.com/in/adriancorrendo/", align: right}
        theme:
            bg: "#edeec9"
            fg: "#272640"
            primary: "#272640"
            navbar-bg: "#fb8f67"
            base_font: !expr bslib::font_google("Oswald")
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(shinydashboard)
library(shinythemes)
library(bslib)
library(dplyr)
library(tidyr)
library(ggplot2)
library(xgboost)
library(plotly)
library(DT)
tags$style("@import url(https://use.fontawesome.com/releases/v6.1.1/css/all.css);")
```

```{r}

# Loading Data
curvas <- readRDS( file = "data/curvas.RDS")
coeff <- readRDS( file = "data/coeff.RDS")

```

## Column {data-width="150"}

### Inputs

```{r}

# N price
shiny::sliderInput("N_price", "N cost, $/kg N", value = 1.0,  min = 0.5, max = 3.5)

# Grain price
shiny::sliderInput("Grain_price", "Grain price, $/kg grain", value = 0.1,  min = 0.05, max = 0.2)

# Soil N
shiny::sliderInput("PPNT", "Pre-plant NO3-N Test, kg N/ha", value = 60,  min = 0, max = 300)

shiny::selectInput(
  inputId = "texture_choice",
  label   = "Select soil texture group",
  choices = c("Very-Low (<8.5 Mg/ha)" = "1.Muy bajo",
              "Low (>8.5 Mg/ha)" = "2.Bajo",
              "Medium (>10.1 Mg/ha)" = "3.Medio",
              "High (>11.5 Mg/ha)" = "4.Alto",
              "Very-High (>13.1 Mg/ha)" = "5.Muy Alto")
  )

shiny::selectInput(
  inputId = "yield_environment_choice",
  label   = "Select yield environment level",
  choices = c("Clay" = "Fine",
              "Medium" = "Medium",
              "Coarse" = "Coarse")
  )

```

## Column {data-width="400"}

### Plot

```{r}
ELSE = TRUE

data_plot <- reactive({
  curvas %>% 
     filter(Q == input$texture_choice,
            TEXT == input$yield_environment_choice )
  })

plotgraph <- reactive({
    
            ggplot(data_plot(), aes(x = Ns, y = y))+
    
            geom_path(size = 2,
                      color = case_when(input$yield_environment_choice == "Fine" ~ "#ba3037",
                                        input$yield_environment_choice == "Medium" ~ "#2c61d4",
                                        input$yield_environment_choice == "Coarse" ~ "#5e691f"))+
    
            scale_y_continuous(breaks=seq(0,20000, 2000), limits = c(0,18000))+
    
            scale_x_continuous(breaks=seq(0,400, 50), limits = c(0,400))+
    
            theme_bw()+
    
            labs(x = bquote(~ N[soil+fertilizer]* '(kg N ' ~ha^-1*')'),
                  y = bquote(~ 'Corn Grain Yield (kg' ~ha^-1*')'))+
    
            theme(
              axis.text.x = element_text(size=rel(1.25), color = "black"),
              axis.text.y = element_text(size=rel(1.25), color = "black"),
              axis.title = element_text(size=rel(1.75), color = "black"),
              strip.text = element_text(size=rel(1.25), color = "black"),
              legend.title = element_text(size = rel(1)),
              legend.position = "top", legend.key.size = unit(2.5,"line"),
              legend.text = element_text(size = rel(1)),
              legend.key.width = unit(2.5,"line")
             )

})

renderPlot({ 

  plotgraph()
  
})
```

## Column {data-width="180"}

### Price Ratio
```{r}

PRatio <- eventReactive( 
  
  input$N_price / input$Grain_price,
  round(as.numeric(input$N_price/ input$Grain_price), 1)
  
  )

flexdashboard::renderGauge({
  
  flexdashboard::gauge( PRatio(), min = 0, max = 70, symbol = '',
                        gaugeSectors( success = c(0,6), warning = c(6.001,10), danger = c(12, 15),
                                      colors = c("green", "orange", "red")
                        )
  )
  
})

```

### Dosis Optima Agronomica

```{r}

Outputs <- reactive({
  
  coeff %>%
    filter(Q == input$texture_choice,
           TEXT == input$yield_environment_choice)%>%
    mutate(AONav = Xc,
           AONr = ifelse(Xc - input$PPNT >= 0, Xc - input$PPNT, 0),
           EONav = (PRatio() - b)/(2*B2),
           EONr = ifelse(((PRatio() - b)/(2*B2)- input$PPNT) >= 0,((PRatio() - b)/(2*B2)- input$PPNT),0 )  )

})


flexdashboard::renderValueBox({
  
  flexdashboard::valueBox(paste(round(Outputs()$AONr,2), "kg N/ha"), 
            "Dosis Optima Agronomica", 
            icon = "fa-leaf", 
            color = "#2a9d8f")
  }) 

```

### Dosis Optima Economica

```{r}


flexdashboard::renderValueBox({
  
  flexdashboard::valueBox(paste(round(Outputs()$EONr, 2), "kg N/ha"), 
            "Dosis Optima Economica", 
            icon = "fa-usd", 
            color = "#fb8f67")
  
  }) 

```
