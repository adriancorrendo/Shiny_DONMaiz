---
title: "DONMaiz"
author: Dosis Optima de N en Maiz
output: 
  flexdashboard::flex_dashboard:
        orientation: columns
        navbar:
           - { icon: "fa-github", href: "https://github.com/adriancorrendo/", align: right }
           - { icon: "fa-twitter", href: "https://twitter.com/aacorrendo/", align: right}
           - { icon: "fa-linkedin", href: "https://www.linkedin.com/in/adriancorrendo/", align: right}
        theme:
            bg: "#edeec9"
            fg: "#272640"
            primary: "#d19d43"
            navbar-bg: "#cc8125"
            base_font: !expr bslib::font_google("Oswald")
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(shinydashboard)
library(shinythemes)
library(bslib)
library(dplyr)
library(tidyr)
library(ggplot2)
library(xgboost)
library(plotly)
library(DT)
tags$style("@import url(https://use.fontawesome.com/releases/v6.1.1/css/all.css);")
```

```{r}

# Loading Data
curvas <- readRDS( file = "data/curvas.RDS")
coeff <- readRDS( file = "data/coeff.RDS")

```

## Column {data-width="150"}

### Inputs

```{r}
# Yield Environment
shiny::selectInput(
  inputId = "texture_choice",
  label   = "Seleccione Ambiente de Rendimiento",
  choices = c("Muy Bajo (<8.5 Mg/ha)" = "1.Muy bajo",
              "Bajo (>8.5 Mg/ha)" = "2.Bajo",
              "Medio (>10.1 Mg/ha)" = "3.Medio",
              "Alto (>11.5 Mg/ha)" = "4.Alto",
              "Muy Alto (>13.1 Mg/ha)" = "5.Muy Alto")
  )

# Soil Texture
shiny::selectInput(
  inputId = "yield_environment_choice",
  label   = "Seleccione Textura de Suelo",
  choices = c("Arcilloso" = "Fine",
              "Medio" = "Medium",
              "Arenoso" = "Coarse")
  )

# N price
shiny::sliderInput("N_price", "Costo N, US$/kg N", value = 2.8,  min = 1, max = 3.0, step = 0.1)

# Grain price
shiny::sliderInput("Grain_price", "Precio Grano, US$/kg grano", value = 0.22,  min = 0.1, max = 0.7, step = 0.1)

# Soil N
shiny::sliderInput("PPNT", "N-NO3 Pre-siembra, kg N/ha (0-60cm)", value = 70,  min = 0, max = 250, step = 50)



```

## Column {data-width="400"}

### Plot

```{r}
ELSE = TRUE

data_plot <- reactive({
  curvas %>% 
     filter(Q == input$texture_choice,
            TEXT == input$yield_environment_choice )
  })

plotgraph <- reactive({
    
            ggplot(data_plot(), aes(x = Ns, y = y))+
    
            geom_path(size = 2,
                      color = case_when(input$yield_environment_choice == "Fine" ~ "#ba3037",
                                        input$yield_environment_choice == "Medium" ~ "#2c61d4",
                                        input$yield_environment_choice == "Coarse" ~ "#5e691f"))+
    
            scale_y_continuous(breaks=seq(0,20000, 2000), limits = c(0,18000))+
    
            scale_x_continuous(breaks=seq(0,400, 50), limits = c(0,400))+
    
            theme_bw()+
    
            labs(x = bquote(~ N[suelo+fertilizante]* '(kg N ' ~ha^-1*')'),
                  y = bquote(~ 'Rendimiento Maiz (kg' ~ha^-1*')'))+
    
            theme(
              axis.text.x = element_text(size=rel(1.25), color = "black"),
              axis.text.y = element_text(size=rel(1.25), color = "black"),
              axis.title = element_text(size=rel(1.75), color = "black"),
              strip.text = element_text(size=rel(1.25), color = "black"),
              legend.title = element_text(size = rel(1)),
              legend.position = "top", legend.key.size = unit(2.5,"line"),
              legend.text = element_text(size = rel(1)),
              legend.key.width = unit(2.5,"line")
             )

})

renderPlot({ 

  plotgraph()
  
})
```

## Column {data-width="180"}

### Relacion de Precios
```{r}

PRatio <- eventReactive( 
  
  input$N_price / input$Grain_price,
  round(as.numeric(input$N_price/ input$Grain_price), 1)
  
  )

flexdashboard::renderGauge({
  
  flexdashboard::gauge( PRatio(), min = 0, max = 70, symbol = '',
                        gaugeSectors( success = c(0,6), warning = c(6.001,10), danger = c(12, 15),
                                      colors = c("green", "orange", "red")
                        )
  )
  
})

```

### Dosis Optima Agronomica

```{r}

Outputs <- reactive({
  
  coeff %>%
    filter(Q == input$texture_choice,
           TEXT == input$yield_environment_choice)%>%
    mutate(AONav = Xc,
           AONr = ifelse(Xc - input$PPNT >= 0, Xc - input$PPNT, 0),
           EONav = (PRatio() - b)/(2*B2),
           EONr = ifelse(((PRatio() - b)/(2*B2)- input$PPNT) >= 0,((PRatio() - b)/(2*B2)- input$PPNT),0 )  )

})


flexdashboard::renderValueBox({
  
  flexdashboard::valueBox(paste(round(Outputs()$AONr,0), "kg N/ha"), 
            "Dosis Optima Agronomica", 
            icon = "fa-leaf", 
            color = "#2a9d8f")
  }) 

```

### Dosis Optima Economica

```{r}


flexdashboard::renderValueBox({
  
  flexdashboard::valueBox(paste(round(Outputs()$EONr, 0), "kg N/ha"), 
            "Dosis Optima Economica", 
            icon = "fa-usd", 
            color = "#fb8f67")
  
  }) 

```
